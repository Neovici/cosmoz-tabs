<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-multi-selectable.html">

<script>
(function () {
	'use strict';

	window.Cosmoz = window.Cosmoz || {};

	/**
	 * @polymerBehavior Cosmoz.TabbableBehavior
	*/
	Cosmoz.TabbableBehaviorImpl = {
		properties: {

			/**
			 * Toggles the accordion mode for the element.
			 * If true the element allows multiple selections.
			 *
			 */
			accordion: {
				type: Boolean,
				value: false,
				notify: true,
				reflectToAttribute: true
			},

			/**
			 * The event that fires from items when they are selected. Selectable
			 * will listen for this event from items and update the selection state.
			 * Set to empty string to listen to no events.
			 */
			activateEvent: {
				type: String,
				value: null
			},

			/**
			 * The class to set on elements when selected.
			 */
			selectedClass: {
				type: String,
				value: 'cosmoz-selected'
			},

			/**
			 * The attribute to set on elements when selected.
			 */
			selectedAttribute: {
				type: String,
				value: 'is-selected'
			},

			/**
			 * If true, multiple selections are allowed.
			 */
			multi: {
				type: String,
				computed: '_computeMulti(accordion)'
			}
		},

		listeners: {
			'cosmoz-tab-toggle': '_onToggleTab',
		},

		observers: [
			'_forwardProperty("accordion", accordion, items)',
			'_forwardProperty("flex", flex, items)'
		],

		/**
		 * Computes the `multi` property depending on
		 * `accordion` value
		 *
		 * @param  {Boolean} accordion The `accordion` property
		 * @returns {Boolean} True if accordion is true
		 */
		_computeMulti: function (accordion){
			return !!accordion;
		},


		/**
		 * Handles the `cosmoz-tab-toggle` fired from an item
		 * and toggles selection on that item.
		 *
		 * @param  {Event} e The `cosmoz-tab-toggle` event
		 * @returns {void}
		 */
		_onToggleTab: function (e){
			var item = e.target,
				index = this.items.indexOf(item);

			if (index > -1) {
				this.select(this.attrForSelected ? this._valueForItem(item) : index);
			}
		},

		/**
		 * Forwards a property to all items.
		 *
		 * @param  {String} property The name of the property
		 * @param  {*} value The value of the property
		 * @param  {Array} items The items to forward property to
		 * @returns {void}
		 */
		_forwardProperty: function (property, value, items) {
			items.forEach(function (item){
				item.set(property, value);
			});
		},

		/**
		 * Computes the value for item depending on a attribute.
		 *
		 * @param  {HTMLElement} item The item to compute value for
		 * @param  {type} attr The attribute used to compute the value
		 * @returns {String|Number|void} The compute value
		 */
		_valueForItem: function (item, attr = this.attrForSelected) {
			if (!item) {
				return;
			}
			var propValue = item[Polymer.CaseMap.dashToCamelCase(attr)];
			return propValue !== undefined ? propValue : item.getAttribute(attr);
		},
	};

	/** @polymerBehavior */
	Cosmoz.TabbableBehavior = [
		Polymer.IronResizableBehavior,
		Polymer.IronMultiSelectableBehavior,
		Cosmoz.TabbableBehaviorImpl
	];
})();
</script>
