<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-selector/iron-multi-selectable.html">

<script>
(function () {
	'use strict';

	window.Cosmoz = window.Cosmoz || {};

	/**
	 * @polymerBehavior Cosmoz.TabbableBehavior
	*/
	Cosmoz.TabbableBehaviorImpl = {
		properties: {

			/**
			 * Toggles the accordion mode for the element.
			 * If true the element allows multiple selections.
			 *
			 */
			accordion: {
				type: Boolean,
				value: false,
				notify: true,
				reflectToAttribute: true
			},

			/**
			 * The event that fires from items when they are selected. Selectable
			 * will listen for this event from items and update the selection state.
			 * Set to empty string to listen to no events.
			 */
			activateEvent: {
				type: String,
				value: null
			},

			/**
			 * The class to set on elements when selected.
			 */
			selectedClass: {
				type: String,
				value: 'cosmoz-selected'
			},

			/**
			 * The attribute to set on elements when selected.
			 */
			selectedAttribute: {
				type: String,
				value: 'is-selected'
			},

			/**
			 * If true, multiple selections are allowed.
			 */
			multi: {
				type: String,
				computed: '_computeMulti(accordion)'
			},

			/**
			 * Gets or sets the selected elements. This is used instead of `selected` when `multi`
			 * is true.
			 */
			selectedValues: {
				type: Array,
				notify: true,
				value: function () {
					return [];
				}
			},
			/**
			 * Returns an array of currently selected items.
			 */
			selectedItems: {
				type: Array,
				readOnly: true,
				notify: true,
				value: function () {
					return [];
				}
			}
		},

		listeners: {
			'cosmoz-tab-toggle': '_onToggleTab',
			'iron-select': '_onIronSelect',
			'tab-activate': '_onTabActivate'
		},

		observers: [
			'_forwardProperty("accordion", accordion, items)'
		],

		/**
		 * Computes the `multi` property depending on
		 * `accordion` value
		 *
		 * @param  {Boolean} accordion The `accordion` property
		 * @returns {Boolean} True if accordion is true
		 */
		_computeMulti: function (accordion){
			return !!accordion;
		},


		/**
		 * Handles the `cosmoz-tab-toggle` fired from an item
		 * and toggles selection on that item.
		 *
		 * @param  {Event} e The `cosmoz-tab-toggle` event
		 * @returns {void}
		 */
		_onToggleTab: function (e){
			var item = e.target,
				index = this.items.indexOf(item),
				value;

			if (index > -1) {
				value = this._indexToValue(index);
				if (!this.fire('tab-activate', {selected: value, item: item}, {cancelable: true}).defaultPrevented) {
					this.select(value);
				}
			}
		},

		/**
		 * Forwards a property to all items.
		 *
		 * @param  {String} property The name of the property
		 * @param  {*} value The value of the property
		 * @param  {Array} items The items to forward property to
		 * @returns {void}
		 */
		_forwardProperty: function (property, value, items) {
			items.forEach(function (item){
				item.set(property, value);
			});
		},

		/**
		 * Computes the value for item depending on a attribute.
		 *
		 * @param  {HTMLElement} item The item to compute value for
		 * @param  {type} attr The attribute used to compute the value
		 * @returns {String|Number|void} The compute value
		 */
		_valueForItem: function (item, attr = this.attrForSelected) {
			if (!item) {
				return;
			}
			var propValue = item[Polymer.CaseMap.dashToCamelCase(attr)];
			return propValue !== undefined ? propValue : item.getAttribute(attr);
		},

		/**
		 * Listens to `iron-select` event and fires
		 * `tab-first-select` and `tab-select` on the selected item.
		 *
		 * @param  {Event} e  The event object
		 * @param  {Object} detail The detail object
		 * @param  {HTMLElement} detail.item The item being selected.
		 * @fires 'tab-first-select'
		 * @fires 'tab-select'
		 * @return {void}        description
		 */
		_onIronSelect: function (e, detail){
			var item = detail.item,
				index = this.items.indexOf(item),
				opts = {node: item, bubbles: false };

			if (index > -1) {
				this.async(this.notifyResize);

				if (!item._previouslySelected) {
					this.fire('tab-first-select', {}, opts);
					item._previouslySelected = true;
				}
				this.fire('tab-select', {}, opts);
			}
		},

		_toggleSelected: function (value) {
			Polymer.IronMultiSelectableBehaviorImpl._toggleSelected.call(this, this._normalizeValue(value));
		},

		_onTabActivate: function (e) {
			if (this.multi && this.fallbackSelection !== null && this.selectedItems.length === 1 && this.selectedItems[0] === e.detail.item){
				e.preventDefault();
			}
		},

		multiChanged: function (multi, old){
			this._selection.multi = multi;

			if (multi && !old && this.selected !== null) {
				this.set('selectedValues', [this._normalizeValue(this.selected)]);
			} else if (!multi && old && this.selectedValues[0]) {
				this.selected = this.selectedValues[0];
			}
			this._updateSelected();
		},

		_normalizeValue: function (value) {
			return  this.attrForSelected ? value : isNaN(value) || value !== null ? value : Number(value);
		}
	};

	/** @polymerBehavior */
	Cosmoz.TabbableBehavior = [
		Polymer.IronResizableBehavior,
		Polymer.IronMultiSelectableBehavior,
		Cosmoz.TabbableBehaviorImpl
	];
})();
</script>
