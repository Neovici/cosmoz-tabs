<link rel="import" href="../polymer/polymer.html">
<script>

/*global CosmozTabs*/
'use strict';

window.CosmozTabs = window.CosmozTabs || {};

/**
  @polymerBehavior CosmozTabs.BindParentHostBehavior
 */
CosmozTabs.BindParentHostBehavior = {
	/**
	 * Fired when a bound children should be notified of property change.
	 *
	 * @event cosmoz-parent-property-changed
	 * @param  {Object} detail The event detail object
	 * @param  {*} detail.value The value of the property
	 * @param  {String} detail.propertyName The name of the property
	 */

	listeners: {
		'cosmoz-bind-parent-property': '_onBindParentProperty',
		'cosmoz-unbind-parent-property': '_onUnbindParentProperty'
	},

	/**
	 * Handles `cosmoz-bind-parent-property` event and
	 * adds `event.detail.element` to bound children.
	 *
	 * @param  {Event} event The `cosmoz-unbind-parent-property` event
	 * @param  {Object} event.detail The event detail object
	 * @param  {HTMLElement} event.detail.element The element to bind
	 * @param  {String} event.detail.propertyName The name of the property
	 * @listens cosmoz-bind-parent-property
	 * @return {void}
	 */
	_onBindParentProperty: function (event) {
		var
			element = event.detail.element,
			propertyName = event.detail.propertyName,
			propertyBoundChildren;

		this._boundChildren = this._boundChildren || {};

		propertyBoundChildren = this._boundChildren[propertyName];

		if (!propertyBoundChildren) {
			propertyBoundChildren = [];
			this._boundChildren[propertyName] = propertyBoundChildren;

		}

		propertyBoundChildren.push(element);

		this._notifyChild(element, propertyName, this[propertyName]);

		event.stopPropagation();
	},

	/**
	 * Handles `cosmoz-unbind-parent-property` event and
	 * removes `event.detail.element` from bound children.
	 *
	 * @param  {Event} event The `cosmoz-unbind-parent-property` event
	 * @param  {Object} event.detail The event detail object
	 * @param  {HTMLElement} event.detail.element The element to remove from `_boundChildren`
	 * @param  {String} event.detail.propertyName The name of the property
	 * @listens cosmoz-unbind-parent-property
	 * @return {void}
	 */
	_onUnbindParentProperty: function (event) {
		var
			element = event.detail.element,
			propertyName = event.detail.propertyName,
			propertyBoundChildren,
			i;

		if (!this._boundChildren) {
			return;
		}

		propertyBoundChildren = this._boundChildren[propertyName];

		if (propertyBoundChildren) {
			i = propertyBoundChildren.indexOf(element);
			if (i >= 0) {
				propertyBoundChildren.splice(i, 1);
			}
		}
		event.stopPropagation();
	},

	/**
	 * Notify all bound children of property changes.
	 *
	 * @param  {String} propertyName Name of the changed property
	 * @return {void}
	 */
	notifyBoundChildren: function (propertyName) {
		var propertyBoundChildren,
			i;
		if (!this._boundChildren) {
			return;
		}

		propertyBoundChildren = this._boundChildren[propertyName];
		for (i = 0; i < propertyBoundChildren.length; i += 1) {
			this._notifyChild(propertyBoundChildren[i], propertyName);
		}
	},

	/**
	 * Notifies a child of property changes.
	 *
	 * @param  {HTMLElement} child        The child to be notified
	 * @param  {String} propertyName  Name of the changed property
	 * @fires cosmoz-parent-property-changed
	 * @return {void}
	 */
	_notifyChild: function (child, propertyName) {
		this.fire('cosmoz-parent-property-changed',
			{
				propertyName: propertyName,
				value: this[propertyName]
			}, {
				node: child,
				bubbles: false,
				cancelable: false
			});
	}

};

</script>
